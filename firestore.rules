rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ═══════════════════════════════════════════════════════════════════════════
    // HELPER FUNCTIONS
    // ═══════════════════════════════════════════════════════════════════════════
    
    // Check if the user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the user is the owner of the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Check if the user is an admin (you can customize this based on your admin UID or custom claims)
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.admin == true ||
        request.auth.uid in ['YOUR_ADMIN_UID_1', 'YOUR_ADMIN_UID_2']
      );
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // FEEDBACK SUBMISSIONS COLLECTION
    // ═══════════════════════════════════════════════════════════════════════════
    
    match /feedback-submit/{feedbackId} {
      // Allow authenticated users to create feedback submissions
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['name', 'email', 'role', 'feedbackType', 'description', 'userId', 'submittedAt', 'status']);
      
      // Users can read their own submissions (get single doc or list/query their docs)
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Users can list their own submissions via query (where userId == auth.uid)
      allow list: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // Users cannot update or delete their submissions (only admins can)
      allow update, delete: if isAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // COLLABORATION SUBMISSIONS COLLECTION
    // ═══════════════════════════════════════════════════════════════════════════
    
    match /collaborate-submit/{collaborationId} {
      // Allow authenticated users to create collaboration submissions
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.keys().hasAll(['submissionTypes', 'source', 'semesterSelection', 'subjectDetails', 'userId', 'submittedAt', 'status']);
      
      // Users can read their own submissions (get single doc or list/query their docs)
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Users can list their own submissions via query (where userId == auth.uid)
      allow list: if isAuthenticated() && request.auth.uid == resource.data.userId;
      
      // Users cannot update or delete their submissions (only admins can)
      allow update, delete: if isAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // USERS COLLECTION
    // ═══════════════════════════════════════════════════════════════════════════
    
    match /users/{userId} {
      // Users can create their own profile document (uid must match document ID)
      allow create: if isAuthenticated() 
                    && request.auth.uid == userId
                    && request.resource.data.uid == userId;
      
      // Users can read their own profile
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can update their own profile (uid must remain unchanged)
      allow update: if isOwner(userId) 
                    && request.resource.data.uid == userId;
      
      // Only admins can delete user profiles
      allow delete: if isAdmin();
    }

    // ═══════════════════════════════════════════════════════════════════════════
    // DEFAULT DENY
    // ═══════════════════════════════════════════════════════════════════════════
    
    // Deny access to all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
